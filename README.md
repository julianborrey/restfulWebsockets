# Restful Websockets #

This repo contains two files which allow you to modify a web page 
served by a Rails app in a RESTful way while using HTML5 websockets.
One file is a rails helper file which will construct new 
HTML for partials which you specify need to be refreshed. The second 
file is a JavaScript file which will unpackage the partials and 
refresh them live on the page.

### Why? ###
Websockets allows for server-client communication without consistently 
making new HTTP requests. This is very different to REST architecture 
which has strict rules about how each request will alter the database 
resulting in a response of fresh material from an MVC type application.

Ruby on Rails maintains a very nice RESTful architecture but websockets 
can interfere with this by allowing for the flow of data without making 
and entirely new HTTP request. This means that the usual Rails mechanism 
which automatically constructs pages from embedded ruby can not be used 
while in a websockets sessions.

The purpose of this plugin is to allow for the normal construction of 
a Rails application in conjunction with updates, while in a websockets session, of the page
by using the embedded ruby templates. This should hopefully allow 
for application page elements generated by the rails app to remain dynamic 
even without normal HTTP requests occurring.

### Operation ###
During a websockets session data is sent between the server and client 
via JSON objects. The `RestfulWebsocketsHelper` will allow you to add an 
entry to the data going from the server to the client. This entry will 
contain new HTML for elements that you want to replace.

In the usual Rails scenario, these elements would have been updated upon 
a new request by parsing the embedded ruby files in your `view` folder. 
This helper will use the same embedded ruby files to generate new elements 
and so no extra HTML will need to be written.

When the websocket controller is in action .html.erb partials, with inputs, 
can be submitted to the helper. Prior to sending a data response to the 
client the helper will insert all the new HTML for the specified 
partials into the JSON object.

On the client side the `restfulWebsockets.js` file will provide an 
object which will take the new HTML and update the partials on the 
webpage. 


### Interface ###

One the server side you will need to use two functions. Firstly, you need 
to submit the names of partials and their inputs so that they are evaluated.
Only entire partials can be refreshed. No pages or sections of pages.
Additionally, your partial must be entirely enclosed by a `<div>` whose ID 
is the name of the partial. For example, if your partial file is 
`_part.html.erb` then you need to enclose all the code in the file with 
`<div id="part">`.

Now often these embedded ruby files call functions from ActionControllers or 
helpers which are included in ActionControllers. These functions will be 
available during the websocket session but the original controllers which 
were instantiated when the original HTTP request was made will be long gone. 
This means that variables from these controllers are likely to be non-existent. To 
allow for completely dynamic embedded ruby you will need to use data that is 
input to the partial rendering function.

Normally you could call `render('shared/part')` in a .html.erb file and 
you let's assume that in this partial a method, in a controller, `get_name` 
is called. To use this plugin you will need to change the above code to 
`render(partial: 'shared/part', locales: {input1: get_name});`. You can 
have as many inputs in that hash as needed.

To submit a partial for update you will call the method `update_partial_input()`
This method will take the first argument as the partial's file path (relative 
to the `views` folder obviously), the second argument will be the name of an 
input to the partial and the third will be the new value for that input. The 
new value would have been generated by your WebsocketRails controller. 

After you have submitted all new partials and inputs you can call 
`load_data_with_partials().` This will return the JSON object to send to 
client. If you call the method without input it will construct the object for 
you or if you pass in a hash it will add an entry to the hash to store the new HTML.
The code should look something like this:

```ruby
class WSController < WebsocketRails::BaseController
   include RestfulWebsocketsHelper

   def some_foo
      #some method code to generate some new values to be rendered

      #load up the partials to be rendered and the new inputs
      update_partials_input('shared/part', input1, new_name);
      update_partials_input('shared/part', input2, new_time);
      
      data = {};
      #some method code to generate some data
      
      #re-render and load up paritals into data hash
      data = load_data_with_partials(data);
      
      #send response with data to client
      trigger_success(data);
   end
end
```

On the client side, construct a `RestfulWebsockets` object and execute the 
`refresh` method with the data received by the WebsocketRails JS object. 
The code should look something like this:

```javascript
dispatcher = new WebsocketRails(WEBSOCKET_ADDRESS, true);

//use one of these two lines to bind a method to the event of receiving data
dispatcher.bind('foo', foo);
//or
dispatched.trigger(COMMAND, dataToSend, foo, callbackFail);

//function that the data is passed to
function foo(data) {
   var rs = new RestfulWebsockets();
   rs.refresh(data); 
   //this will update all the partials specified on the server side
}
```


### Installation ###

To install this plugin all you need to do is put the restfulWebsockets.js 
file in your `app/assets/javascript` folder and it should go through 
the pipeline. Put the restful_websockets_helper.rb file in your 
`app/helpers` folder and then add `include RestfulWebsocketsHelper` to 
your WebsocketRails controller.


### Requirements ###

* This plugin code was developed with Rails 4 and Ruby 2.0.0.
* You will need to have the 
  [WebsocketRails Gem](https://github.com/websocket-rails/websocket-rails) 
  installed.
* You will need to have [jquery.cookie.js](https://github.com/carhartl/jquery-cookie) 
  included in your pipeline.


### Should this be a Gem? ###
Since this is one JS file and one helper module I did not turn this plugin into a 
ruby gem. Having said that, I am not sure if I should make this a gem. If 
you think I should, please E-mail me and explain if it will make things easier.


### License ###
This is released under MIT license. Feel free to contribute to this code and make it better.

